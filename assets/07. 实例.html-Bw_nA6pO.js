import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{o as s,c as a,e as t}from"./app-yixEWCFr.js";const p="/assets/Image00049-Muq2u3_5.jpg",e={},o=t(`<h1 id="实例" tabindex="-1"><a class="header-anchor" href="#实例"><span>实例</span></a></h1><p>在对DPDK的原理和代码展开进一步解析之前，先看一些小而简单的例子，建立一个形象上的认知。</p><ol><li><strong>helloworld</strong><ul><li>特点：最基础的入门程序，代码简短简单。</li><li>功能：多核（线程）环境下每个线程打印</li><li>启动基础运行环境，DPDK构建了一个基于操作系统的，但适合包处理的软件运行环境，你可以认为这是个mini-OS。 最早期DPDK，可以完全运行在没有操作系统的物理核（bare-metal）上，这部分代码现在不在主流的开源包中。</li></ul></li><li><strong>skeleton</strong><ul><li>特点：一个最简单的单核报文收发示例</li><li>功能：对收入报文不做任何处理直接发送</li><li>也许这是当前世界上运行最快的报文进出测试程序。</li></ul></li><li><strong>l3fwd</strong><ul><li>特点：DPDK中最流行的例子，也是发布DPDK性能测试的例子</li><li>功能：三层转发是DPDK用于发布性能测试指标的主要应用</li></ul></li></ol><h2 id="helloworld" tabindex="-1"><a class="header-anchor" href="#helloworld"><span>HelloWorld</span></a></h2><h3 id="功能" tabindex="-1"><a class="header-anchor" href="#功能"><span>功能</span></a></h3><p>DPDK里的HelloWorld是<em>最基础的入门程序，代码简短，功能也不复杂</em>。</p><p>它建立了一个多核（线程）运行的基础环境，每个线程会打印 <code>hello from core#</code>，core#是由操作系统管理的。 如无特别说明，本文里的DPDK线程与硬件线程是一一对应的关系。</p><h3 id="代码" tabindex="-1"><a class="header-anchor" href="#代码"><span>代码</span></a></h3><h4 id="main" tabindex="-1"><a class="header-anchor" href="#main"><span>main()</span></a></h4><div class="language-c line-numbers-mode" data-ext="c" data-title="c"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> lcore_id<span class="token punctuation">;</span>
    
    <span class="token comment">// 初始化</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">rte_eal_init</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">rte_panic</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot init EAL\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

    <span class="token comment">// 在每个从lcore上调用lcore hello()</span>
    <span class="token comment">// call lcore_hello() on every slave lcore</span>
    <span class="token function">RTE_LCORE_FOREACH_SLAVE</span><span class="token punctuation">(</span>lcore_id<span class="token punctuation">)</span> <span class="token punctuation">{</span>	
        <span class="token function">rte_eal_remote_launch</span><span class="token punctuation">(</span>lcore_hello<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> lcore_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 调用主lcore</span>
    <span class="token comment">// call it on master lcore too</span>
    <span class="token function">lcore_hello</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rte_eal_mp_wait_lcore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><h5 id="代码说明" tabindex="-1"><a class="header-anchor" href="#代码说明"><span>代码说明</span></a></h5></blockquote><ul><li><strong>eal</strong>：<em>environment abstraction layer</em>，环境抽象层</li><li><strong>rte</strong>：<em>runtime environment</em>，运行时环境 <ul><li>DPDK的<em>主要对外函数接口都以rte_作为前缀</em></li></ul></li><li><strong>lcore</strong>：<em>logi core</em>，逻辑核</li></ul><p>抽象化函数接口是典型软件设计思路，可以帮助DPDK运行在多个操作系统上，DPDK官方支持Linux与FreeBSD。和多数并行处理系统类似，DPDK也有主线程、从线程的差异。</p><blockquote><h5 id="初始化基础运行环境-rte-eal-init" tabindex="-1"><a class="header-anchor" href="#初始化基础运行环境-rte-eal-init"><span>初始化基础运行环境 rte_eal_init</span></a></h5></blockquote><p>主线程运行入口是main函数，调用了rte_eal_init入口函数，启动基础运行环境。</p><div class="language-c line-numbers-mode" data-ext="c" data-title="c"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">rte_eal_init</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>入口参数是启动DPDK的命令行，可以是长长的一串很复杂的设置，需要深入了解的读者可以查看DPDK相关的文档与源代码<code>\\lib\\librte_eal\\common\\eal_common_options.c</code>。</p><p>对于HelloWorld这个实例，最需要的参数是 <code>-c&lt;core mask&gt;</code>，线程掩码（core mask）指定了需要参与运行的线程（核）集合。</p><p>rte_eal_init 本身所完成的工作很复杂，它读取入口参数，解析并保存作为DPDK运行的系统信息，依赖这些信息，构建一个针对包处理设计的运行环境。</p><p>主要动作分解如下：</p><ol><li>配置初始化</li><li>内存初始化</li><li>内存池初始化</li><li>队列初始化</li><li>告警初始化</li><li>中断初始化</li><li>PCI初始化</li><li>定时器初始化</li><li>检测内存本地化（NUMA）</li><li>插件初始化</li><li>主线程初始化</li><li>轮询设备初始化</li><li>建立主从线程通道</li><li>将从线程设置在等待模式</li><li>PCI设备的探测与初始化</li></ol><p>对于DPDK库的使用者，这些操作已经被EAL封装起来，接口清晰。如果需要对DPDK进行深度定制，二次开发，需要仔细研究内部操作，这里不做详解。</p><h4 id="rte-eal-remote-launch-设置亲核性" tabindex="-1"><a class="header-anchor" href="#rte-eal-remote-launch-设置亲核性"><span>rte_eal_remote_launch() 设置亲核性</span></a></h4><p>多核运行初始化</p><p>DPDK面向多核设计，程序会试图独占运行在逻辑核（lcore）上。main函数里重要的是启动多核运行环境，<code>RTE_LCORE_FOREACH_SLAVE(lcore_id)</code> 如名所示，遍历所有EAL指定可以使用的lcore，然后通过rte_eal_remote_launch在每个lcore上，启动被指定的线程。</p><div class="language-c line-numbers-mode" data-ext="c" data-title="c"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">rte_eal_remote_launch</span><span class="token punctuation">(</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>f<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span>
    <span class="token keyword">unsigned</span> slave_id
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 参数lcore_id指定了从线程ID，运行入口函数lcore_hello。</span>
<span class="token comment">/**
 * 第一个参数是从线程，是被征召的线程；
 * 第二个参数是传给从线程的参数；
 * 第三个参数是指定的逻辑核，从线程会执行在这个core上。
 */</span>
<span class="token keyword">int</span> <span class="token function">rte_eal_remote_launch</span><span class="token punctuation">(</span>lcore_hello<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> lcore_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="lcore-hello-线程函数" tabindex="-1"><a class="header-anchor" href="#lcore-hello-线程函数"><span>lcore_hello() 线程函数</span></a></h4><p>运行函数 lcore_hello，它读取自己的逻辑核编号（lcore_id），打印出 <code>“hello from core#”</code></p><div class="language-c line-numbers-mode" data-ext="c" data-title="c"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">lcore_hello</span><span class="token punctuation">(</span><span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>unused<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> lcore_id<span class="token punctuation">;</span>
    lcore_id <span class="token operator">=</span> <span class="token function">rte_lcore_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;hello from core %u\\n&quot;</span><span class="token punctuation">,</span> lcore_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这是个简单示例，从线程很快就完成了指定工作，在更真实的场景里，这个从线程会是一个循环运行的处理过程。</p><h2 id="skeleton" tabindex="-1"><a class="header-anchor" href="#skeleton"><span>Skeleton</span></a></h2><h3 id="功能-1" tabindex="-1"><a class="header-anchor" href="#功能-1"><span>功能</span></a></h3><p>DPDK为多核设计，但这是单核实例，设计初衷是实现<strong>一个最简单的报文收发示例，对收入报文不做任何处理直接发送</strong>。整个代码非常精简，可以用于平台的单核报文出入性能测试。</p><h3 id="代码-1" tabindex="-1"><a class="header-anchor" href="#代码-1"><span>代码</span></a></h3><h4 id="main-1" tabindex="-1"><a class="header-anchor" href="#main-1"><span>main()</span></a></h4><p>主要处理函数main的处理逻辑如下（伪码），调用 rte_eal_init 初始化运行环境，检查网络接口数，据此分配内存池 <code>rte_pktmbuf_pool_create</code>，入口参数是指定 <code>rte_socket_id()</code>，考虑了本地内存使用的范例。调用 <code>port_init(portid, mbuf_pool)</code> 初始化网口的配置，最后调用 <code>lcore_main()</code> 进行主处理流程。</p><div class="language-c line-numbers-mode" data-ext="c" data-title="c"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">rte_mempool</span> <span class="token operator">*</span>mbuf_pool<span class="token punctuation">;</span> 	<span class="token comment">// 内存池</span>
    <span class="token keyword">unsigned</span> nb_ports<span class="token punctuation">;</span>				<span class="token comment">// 端口数</span>
    
    <span class="token comment">// 初始化环境抽象层(EAL)</span>
    <span class="token comment">// Initialize the Environment Abstraction Layer (EAL)</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">rte_eal_init</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 检查是否有偶数个端口可以发送/接收</span>
    <span class="token comment">// Check that there is an even number of ports t send/receive on</span>
    nb_ports <span class="token operator">=</span> <span class="token function">rte_eth_dev_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nb_ports <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">||</span> <span class="token punctuation">(</span>nb_ports <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">rte_exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">,</span> <span class="token string">&quot;Error: number of ports must be even\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 在内存中创建一个新的内存池来保存mbufs</span>
    <span class="token comment">// Creates a new mempool in memory to hold the mbufs</span>
    mbuf_pool <span class="token operator">=</span> <span class="token function">rte_pktmbuf_pool_create</span><span class="token punctuation">(</span><span class="token string">&quot;MBUF_POOL&quot;</span><span class="token punctuation">,</span> NUM_MBUFS <span class="token operator">*</span> nb_ports<span class="token punctuation">,</span>
        MBUF_CACHE_SIZE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> RTE_MBUF_DEFAULT_BUF_SIZE<span class="token punctuation">,</span> <span class="token function">rte_socket_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 初始化所有端口</span>
    <span class="token comment">// Initialize all ports</span>
    <span class="token class-name">uint8_t</span> portid<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>portid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> portid <span class="token operator">&lt;</span> nb_ports<span class="token punctuation">;</span> portid<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">port_init</span><span class="token punctuation">(</span>portid<span class="token punctuation">,</span> mbuf_pool<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">rte_exit</span><span class="token punctuation">(</span>EXIT_FALURE<span class="token punctuation">,</span> <span class="token string">&quot;Cannot init port %&quot;</span>PRIu8 <span class="token string">&quot;\\n&quot;</span><span class="token punctuation">,</span>
                     portid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 只在主核上调用lcore main</span>
    <span class="token comment">// Call lcore_main on the master core only</span>
    <span class="token function">lcore_main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 网口初始化流程</span>
<span class="token function">port_init</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> port<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">rte_mempool</span> <span class="token operator">*</span>mbuf_pool<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先对指定端口设置队列数，基于简单原则，本例只指定单队列。在收发两个方向上，基于端口与队列进行配置设置，缓冲区进行关联设置。如不指定配置信息，则使用默认配置。</p><h4 id="port-init-网口初始化" tabindex="-1"><a class="header-anchor" href="#port-init-网口初始化"><span>port_init() 网口初始化</span></a></h4><p><strong>网口设置</strong>：对指定端口设置接收、发送方向的队列数目，依据配置信息来指定端口功能</p><div class="language-c line-numbers-mode" data-ext="c" data-title="c"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">rte_eth_dev_configure</span><span class="token punctuation">(</span>
    <span class="token class-name">uint8_t</span> port_id<span class="token punctuation">,</span>
    <span class="token class-name">uint16_t</span> nb_rx_q<span class="token punctuation">,</span> 
    <span class="token class-name">uint16_t</span> nb_tx_q<span class="token punctuation">,</span> 
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">rte_eth_conf</span> <span class="token operator">*</span>dev_conf
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>队列初始化</strong>：对指定端口的某个队列，指定内存、描述符数量、报文缓冲区，并且对队列进行配置</p><div class="language-c line-numbers-mode" data-ext="c" data-title="c"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">rte_eth_rx_queue_setup</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> port_id<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> rx_queue_id<span class="token punctuation">,</span>
              <span class="token class-name">uint16_t</span> nb_rx_desc<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> socket_id<span class="token punctuation">,</span>
              <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">rte_eth_rxconf</span> <span class="token operator">*</span>rx_conf<span class="token punctuation">,</span>
              <span class="token keyword">struct</span> <span class="token class-name">rte_mempool</span> <span class="token operator">*</span>mp<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">rte_eth_tx_queue_setup</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> port_id<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> tx_queue_id<span class="token punctuation">,</span>
              <span class="token class-name">uint16_t</span> nb_tx_desc<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> socket_id<span class="token punctuation">,</span>
              <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">rte_eth_txconf</span> <span class="token operator">*</span>tx_conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>网口设置</strong>：初始化配置结束后，启动端口int rte_eth_dev_start（uint8_t port_id）；</p><p>完成后，读取MAC地址，打开网卡的混杂模式设置，允许所有报文进入。</p><div class="language-c line-numbers-mode" data-ext="c" data-title="c"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">port_init</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> port<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">rte_mempool</span> <span class="token operator">*</span>mbuf_pool<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">rte_eth_conf</span> port_conf <span class="token operator">=</span> port_conf_default<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token class-name">uint16_t</span> rx_rings <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> tx_rings <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// Configure the Ethernet device</span>
    retval <span class="token operator">=</span> <span class="token function">rte_eth_dev_configure</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> rx_rings<span class="token punctuation">,</span> tx_rings<span class="token punctuation">,</span> <span class="token operator">&amp;</span>port_conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Allocate and set up 1 RX queue per Ethernet port</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>q <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> q <span class="token operator">&lt;</span> rx_rings<span class="token punctuation">;</span> q<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        retval <span class="token operator">=</span> <span class="token function">rte_eth_rx_queue_setup</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> q<span class="token punctuation">,</span> RX_RING_SIZE<span class="token punctuation">,</span>
                <span class="token function">rte_eth_dev_socket_id</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> mbuf_pool<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Allocate and set up 1 TX queue per Ethernet port</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>q <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> q <span class="token operator">&lt;</span> tx_rings<span class="token punctuation">;</span> q<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        retval <span class="token operator">=</span> <span class="token function">rte_eth_tx_queue_setup</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> q<span class="token punctuation">,</span> TX_RING_SIZE<span class="token punctuation">,</span>
                <span class="token function">rte_eth_dev_socket_id</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Start the Ethernet port</span>
    retval <span class="token operator">=</span> <span class="token function">rte_eth_dev_start</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Display the port MAC address</span>
    <span class="token keyword">struct</span> <span class="token class-name">ether_addr</span> addr<span class="token punctuation">;</span>
    <span class="token function">rte_eth_macaddr_get</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Enable RX in promiscuous mode for the Ethernet device</span>
    <span class="token function">rte_eth_promiscuous_enable</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>网口收发报文循环收发在lcore_main中有个简单实现，因为是示例，为保证性能，首先检测CPU与网卡的Socket是否最优适配，建议使用本地CPU就近操作网卡，后续章节有详细说明。数据收发循环非常简单，为高速报文进出定义了burst的收发函数如下，4个参数意义非常直观：端口，队列，报文缓冲区以及收发包数。</p><h4 id="rte-eth-rx-tx-burst-收发函数" tabindex="-1"><a class="header-anchor" href="#rte-eth-rx-tx-burst-收发函数"><span>rte_eth_[rx/tx]_burst() 收发函数</span></a></h4><p><strong>基于端口队列的报文收发函数</strong>：</p><div class="language-c line-numbers-mode" data-ext="c" data-title="c"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token class-name">uint16_t</span> <span class="token function">rte_eth_rx_burst</span><span class="token punctuation">(</span>
    <span class="token class-name">uint8_t</span> port_id<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> queue_id<span class="token punctuation">,</span> 
	<span class="token keyword">struct</span> <span class="token class-name">rte_mbuf</span> <span class="token operator">*</span><span class="token operator">*</span>rx_pkts<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">uint16_t</span> nb_pkts
<span class="token punctuation">)</span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token class-name">uint16_t</span> <span class="token function">rte_eth_tx_burst</span><span class="token punctuation">(</span>
    <span class="token class-name">uint8_t</span> port_id<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> queue_id<span class="token punctuation">,</span> 
	<span class="token keyword">struct</span> <span class="token class-name">rte_mbuf</span> <span class="token operator">*</span><span class="token operator">*</span>tx_pkts<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> nb_pkts
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这就构成了最基本的DPDK报文收发展示。可以看到，此处不涉及任何具体网卡形态，软件接口对硬件没有依赖。</p><div class="language-c line-numbers-mode" data-ext="c" data-title="c"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>noreturn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">void</span> <span class="token function">lcore_main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> nb_ports <span class="token operator">=</span> <span class="token function">rte_eth_dev_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> port<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>port <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> port <span class="token operator">&lt;</span> nb_ports<span class="token punctuation">;</span> port<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rte_eth_dev_socket_id</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                <span class="token function">rte_eth_dev_socket_id</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span> <span class="token operator">!=</span>
                        <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">rte_socket_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;WARNING, port %u is on remote NUMA node to &quot;</span>
                    <span class="token string">&quot;polling thread.\\n\\tPerformance will &quot;</span>
                    <span class="token string">&quot;not be optimal.\\n&quot;</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Run until the application is quit or killed</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*
         * Receive packets on a port and forward them on the paired
         * port. The mapping is 0 -&gt; 1, 1 -&gt; 0, 2 -&gt; 3, 3 -&gt; 2, etc.
         */</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>port <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> port <span class="token operator">&lt;</span> nb_ports<span class="token punctuation">;</span> port<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Get burst of RX packes, from first port of pair</span>
            <span class="token keyword">struct</span> <span class="token class-name">rte_mbuf</span> <span class="token operator">*</span>bufs<span class="token punctuation">[</span>BURST_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token class-name">uint16_t</span> nb_rx <span class="token operator">=</span> <span class="token function">rte_eth_rx_burst</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    bufs<span class="token punctuation">,</span> BURST_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>nb_rx <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token comment">// Send burst of TX packets, to second port of pair</span>
            <span class="token keyword">const</span> <span class="token class-name">uint16_t</span> nb_tx <span class="token operator">=</span> <span class="token function">rte_eth_tx_burst</span><span class="token punctuation">(</span>port <span class="token operator">^</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    bufs<span class="token punctuation">,</span> nb_rx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Free any unsent packets</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>nb_tx <span class="token operator">&lt;</span> nb_rx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">uint16_t</span> buf<span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>buf <span class="token operator">=</span> nb_tx<span class="token punctuation">;</span> buf <span class="token operator">&lt;</span> nb_rx<span class="token punctuation">;</span> buf<span class="token operator">++</span><span class="token punctuation">)</span>
                    <span class="token function">rte_pktmbuf_free</span><span class="token punctuation">(</span>bufs<span class="token punctuation">[</span>buf<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="l3fwd" tabindex="-1"><a class="header-anchor" href="#l3fwd"><span>L3fwd</span></a></h2><p><strong>这是DPDK中最流行的例子，也是发布DPDK性能测试的例子</strong>。</p><p>如果将PCIE插槽上填满高速网卡，将网口与大流量测试仪表连接，它能展示在双路服务器平台具备 <strong>200Gbit/s</strong> 的转发能力。数据包被收入系统后，会查询IP报文头部，依据目标地址进行路由查找，发现目的端口，修改IP头部后，将报文从目的端口送出。路由查找有两种方式，一种方式是基于目标IP地址的完全匹配（exact match），另一种方式是基于路由表的最长掩码匹配（Longest Prefix Match，LPM）。三层转发的实例代码文件有2700多行（含空行与注释行），整体逻辑其实很简单，是前续 HelloWorld 与 Skeleton 的结合体。</p><h3 id="启动参数" tabindex="-1"><a class="header-anchor" href="#启动参数"><span>启动参数</span></a></h3><p>启动这个例子，指定命令参数格式如下：</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>./build/l3fwd <span class="token punctuation">[</span>EAL options<span class="token punctuation">]</span> -- <span class="token parameter variable">-p</span> PORTMASK <span class="token punctuation">[</span>-P<span class="token punctuation">]</span> 

--config<span class="token punctuation">(</span>port,queue,lcore<span class="token punctuation">)</span><span class="token punctuation">[</span>,<span class="token punctuation">(</span>port,queue,lcore<span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>命令参数分为 <strong>两个部分，以 “--” 为分界线</strong>：</p><ul><li>分界线左边：是DPDK的EAL Options <ul><li><code>[EAL Options]</code> 是DPDK运行环境的输入配置选项，输入命令会交给 rte_eal_init 处理；</li></ul></li><li>分界线右边：是三层转发的私有命令选项 <ul><li><code>PORTMASK</code> 依据掩码选择端口，DPDK启动时会搜索系统认识的PCIe设备，依据黑白名单原则来决定是否接管，早期版本可能会接管所有端口，断开网络连接。现在可以通过脚本绑定端口，具体可以参见 http://www.dpdk.org/browse/dpdk/tree/tools/dpdk_nic_bind.py</li><li><code>config</code> 选项指定（port，queue，lcore），用指定线程处理对应的端口的队列。要实现200Gbit/s的转发，需要大量线程（核）参与，并行转发</li></ul></li></ul><figure><img src="`+p+`" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>先来看主线程流程main的处理流程，因为和HelloWorld与Skeleton类似，不详细叙述。</p><div class="language-c line-numbers-mode" data-ext="c" data-title="c"><pre class="language-c"><code><span class="token comment">// 初始化运行环境</span>
<span class="token function">rte_eal_init</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 分析入参</span>
<span class="token function">parse_args</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 初始化 lcore 与 port 配置端口与队列初始化，类似 Skeleton 处理端口启动，使能混杂模式启动从线程，令其运行</span>
<span class="token function">main_loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从线程执行main_loop（）的主要步骤如下：</p><div class="language-c line-numbers-mode" data-ext="c" data-title="c"><pre class="language-c"><code><span class="token comment">// 读取自己的 lcore 信息完成配置;</span>
<span class="token comment">// 读取关联的接收与发送队列信息;</span>
<span class="token comment">// 进入循环处理</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 向指定队列批量发送报文;</span>
    <span class="token comment">// 从指定队列批量接收报文;</span>
    <span class="token comment">// 批量转发接收到报文;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>向指定队列批量发送报文，从指定队列批量接收报文，此前已经介绍了DPDK的收发函数。批量转发接收到的报文是处理的主体，提供了基于Hash的完全匹配转发，也可以基于最长匹配原则（LPM）进行转发。转发路由查找方式可以由编译配置选择。除了路由转发算法的差异，下面的例子还包括基于 multi buffer 原理的代码实现。在 <code>#if(ENABLE_MULTI_BUFFER_OPTIMIZE==1)</code> 的路径下，一次处理8个报文。</p><p>和普通的软件编程不同，初次见到的程序员会觉得奇怪。它的实现有效利用了处理器内部的乱序执行和并行处理能力，能显著提高转发性能。</p><div class="language-c line-numbers-mode" data-ext="c" data-title="c"><pre class="language-c"><code><span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> j <span class="token operator">+=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint32_t</span> pkt_type <span class="token operator">=</span>
        pkts_burst<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">-&gt;</span>packet_type <span class="token operator">&amp;</span>
        pkts_burst<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>packet_type <span class="token operator">&amp;</span>
        pkts_burst<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>packet_type <span class="token operator">&amp;</span>
        pkts_burst<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>packet_type <span class="token operator">&amp;</span>
        pkts_burst<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>packet_type <span class="token operator">&amp;</span>
        pkts_burst<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>packet_type <span class="token operator">&amp;</span>
        pkts_burst<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>packet_type <span class="token operator">&amp;</span>
        pkts_burst<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>packet_type<span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt_type <span class="token operator">&amp;</span> RTE_PTYPE_L3_IPV4<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">simple_ipv4_fwd_8pkts</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pkts_burst<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> portid<span class="token punctuation">,</span> qconf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt_type <span class="token operator">&amp;</span> RTE_PTYPE_L3_IPV6<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">simple_ipv6_fwd_8pkts</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pkts_burst<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> portid<span class="token punctuation">,</span> qconf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">l3fwd_simple_forward</span><span class="token punctuation">(</span>pkts_burst<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span>portid<span class="token punctuation">,</span> qconf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">l3fwd_simple_forward</span><span class="token punctuation">(</span>pkts_burst<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>portid<span class="token punctuation">,</span> qconf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">l3fwd_simple_forward</span><span class="token punctuation">(</span>pkts_burst<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>portid<span class="token punctuation">,</span> qconf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">l3fwd_simple_forward</span><span class="token punctuation">(</span>pkts_burst<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>portid<span class="token punctuation">,</span> qconf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">l3fwd_simple_forward</span><span class="token punctuation">(</span>pkts_burst<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>portid<span class="token punctuation">,</span> qconf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">l3fwd_simple_forward</span><span class="token punctuation">(</span>pkts_burst<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>portid<span class="token punctuation">,</span> qconf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">l3fwd_simple_forward</span><span class="token punctuation">(</span>pkts_burst<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>portid<span class="token punctuation">,</span> qconf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">l3fwd_simple_forward</span><span class="token punctuation">(</span>pkts_burst<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>portid<span class="token punctuation">,</span> qconf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> nb_rx <span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">l3fwd_simple_forward</span><span class="token punctuation">(</span>pkts_burst<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span>portid<span class="token punctuation">,</span> qconf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>依据IP头部的五元组信息，利用rte_hash_lookup来查询目标端口。</p><div class="language-c line-numbers-mode" data-ext="c" data-title="c"><pre class="language-c"><code>mask0 <span class="token operator">=</span> <span class="token function">_mm_set_epi32</span><span class="token punctuation">(</span>ALL_32_BITS<span class="token punctuation">,</span> ALL_32_BITS<span class="token punctuation">,</span> ALL_32_BITS<span class="token punctuation">,</span> BIT_8_TO_15<span class="token punctuation">)</span><span class="token punctuation">;</span>

ipv4_hdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>ipv4_hdr <span class="token operator">+</span> <span class="token function">offsetof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ipv4_hdr</span><span class="token punctuation">,</span> time_to_live<span class="token punctuation">)</span><span class="token punctuation">;</span>

__m128i data <span class="token operator">=</span> <span class="token function">_mm_loadu_si128</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__m128i<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ipv4_hdr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取5元组:dst端口，src端口，dst IP地址，src IP地址和协议</span>
<span class="token comment">// Get 5 tuple: dst port, src port, dst IP address, src IP address and protocol</span>
key<span class="token punctuation">.</span>xmm <span class="token operator">=</span> <span class="token function">_mm_and_si128</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> mask0<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 查找目的端口</span>
<span class="token comment">// Find destination port</span>
ret <span class="token operator">=</span> <span class="token function">rte_hash_lookup</span><span class="token punctuation">(</span>ipv4_l3fwd_lookup_struct<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> portid <span class="token operator">:</span> ipv4_l3fwd_out_if<span class="token punctuation">[</span>ret<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这段代码在读取报文头部信息时，将整个头部导入了基于SSE的矢量寄存器（128位宽），并对内部进行了掩码mask0运算，得到key，然后把key作为入口参数送入rte_hash_lookup运算。同样的操作运算还展示在对IPv6的处理上，可以在代码中参考。</p><h2 id="本书偏重原理而非代码" tabindex="-1"><a class="header-anchor" href="#本书偏重原理而非代码"><span>本书偏重原理而非代码</span></a></h2><p>我们并不计划在本节将读者带入代码陷阱中，实际上本书总体上也没有偏重代码讲解，而是在原理上进行解析。如果读者希望了解详细完整的编程指南，可以参考DPDK的网站。</p>`,73),c=[o];function l(i,u){return s(),a("div",null,c)}const d=n(e,[["render",l],["__file","07. 实例.html.vue"]]),m=JSON.parse('{"path":"/MdNote_Public/01.%20%E8%AE%BE%E8%AE%A1%E5%BC%80%E5%8F%91%E4%B8%8E%E6%95%B0%E6%8D%AE%E7%94%9F%E4%BA%A7/Develop/02.%20Theory/Computer/03.%20%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%20-%20%E4%B8%93%E9%A2%98%E6%88%96%E5%AD%90%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%AD%97%E5%85%B8%E7%89%88/%E4%B8%8B%E5%B1%82%E7%9B%B8%E5%85%B3/Network/%E3%80%8ANFV%E7%9A%84%E5%9F%BA%E7%9F%B3_%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BADPDK%E3%80%8B/01.%20%E8%AE%A4%E8%AF%86DPDK/07.%20%E5%AE%9E%E4%BE%8B.html","title":"实例","lang":"zh-CN","frontmatter":{"description":"实例 在对DPDK的原理和代码展开进一步解析之前，先看一些小而简单的例子，建立一个形象上的认知。 helloworld 特点：最基础的入门程序，代码简短简单。 功能：多核（线程）环境下每个线程打印 启动基础运行环境，DPDK构建了一个基于操作系统的，但适合包处理的软件运行环境，你可以认为这是个mini-OS。 最早期DPDK，可以完全运行在没有操作系统...","head":[["meta",{"property":"og:url","content":"http://192.168.0.101:8080/MdNote_Public/01.%20%E8%AE%BE%E8%AE%A1%E5%BC%80%E5%8F%91%E4%B8%8E%E6%95%B0%E6%8D%AE%E7%94%9F%E4%BA%A7/Develop/02.%20Theory/Computer/03.%20%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%20-%20%E4%B8%93%E9%A2%98%E6%88%96%E5%AD%90%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%AD%97%E5%85%B8%E7%89%88/%E4%B8%8B%E5%B1%82%E7%9B%B8%E5%85%B3/Network/%E3%80%8ANFV%E7%9A%84%E5%9F%BA%E7%9F%B3_%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BADPDK%E3%80%8B/01.%20%E8%AE%A4%E8%AF%86DPDK/07.%20%E5%AE%9E%E4%BE%8B.html"}],["meta",{"property":"og:site_name","content":"Linc 的小站"}],["meta",{"property":"og:title","content":"实例"}],["meta",{"property":"og:description","content":"实例 在对DPDK的原理和代码展开进一步解析之前，先看一些小而简单的例子，建立一个形象上的认知。 helloworld 特点：最基础的入门程序，代码简短简单。 功能：多核（线程）环境下每个线程打印 启动基础运行环境，DPDK构建了一个基于操作系统的，但适合包处理的软件运行环境，你可以认为这是个mini-OS。 最早期DPDK，可以完全运行在没有操作系统..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"article:author","content":"LincZero"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"实例\\",\\"image\\":[\\"\\"],\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"LincZero\\",\\"url\\":\\"https://github.com/LincZero/\\"}]}"]]},"headers":[{"level":1,"title":"实例","slug":"实例","link":"#实例","children":[{"level":2,"title":"HelloWorld","slug":"helloworld","link":"#helloworld","children":[{"level":3,"title":"功能","slug":"功能","link":"#功能","children":[]},{"level":3,"title":"代码","slug":"代码","link":"#代码","children":[{"level":4,"title":"main()","slug":"main","link":"#main","children":[]},{"level":4,"title":"rte_eal_remote_launch() 设置亲核性","slug":"rte-eal-remote-launch-设置亲核性","link":"#rte-eal-remote-launch-设置亲核性","children":[]},{"level":4,"title":"lcore_hello() 线程函数","slug":"lcore-hello-线程函数","link":"#lcore-hello-线程函数","children":[]}]}]},{"level":2,"title":"Skeleton","slug":"skeleton","link":"#skeleton","children":[{"level":3,"title":"功能","slug":"功能-1","link":"#功能-1","children":[]},{"level":3,"title":"代码","slug":"代码-1","link":"#代码-1","children":[{"level":4,"title":"main()","slug":"main-1","link":"#main-1","children":[]},{"level":4,"title":"port_init() 网口初始化","slug":"port-init-网口初始化","link":"#port-init-网口初始化","children":[]},{"level":4,"title":"rte_eth_[rx/tx]_burst() 收发函数","slug":"rte-eth-rx-tx-burst-收发函数","link":"#rte-eth-rx-tx-burst-收发函数","children":[]}]}]},{"level":2,"title":"L3fwd","slug":"l3fwd","link":"#l3fwd","children":[{"level":3,"title":"启动参数","slug":"启动参数","link":"#启动参数","children":[]}]},{"level":2,"title":"本书偏重原理而非代码","slug":"本书偏重原理而非代码","link":"#本书偏重原理而非代码","children":[]}]}],"git":{"createdTime":null,"updatedTime":null,"contributors":[]},"readingTime":{"minutes":11.53,"words":3459},"filePathRelative":"MdNote_Public/01. 设计开发与数据生产/Develop/02. Theory/Computer/03. 计算机系统 - 专题或子系统的字典版/下层相关/Network/《NFV的基石_深入浅出DPDK》/01. 认识DPDK/07. 实例.md","autoDesc":true}');export{d as comp,m as data};
